<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QvPen Exporterから出てきたデータを、ログファイル読み込んでいい感じに整えてくれるやつ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        textarea {
            width: 100%;
            height: 200px;
        }
        button {
            margin: 10px;
            padding: 5px 15px;
        }
        #exportList {
            margin: 20px 0;
        }
        .export-item {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #message {
            color: red;
            margin: 10px 0;
        }
    </style>
</head>
<body>
<h1>QvPen Exporterから出てきたデータを、ログファイル読み込んでいい感じに整えてくれるやつ</h1>
<input type="file" id="fileInput">
<textarea id="logInput" placeholder="ログデータを貼り付けてください"></textarea>
<button id="decodeButton">デコード</button>
<div id="exportList"></div>
<div id="message" style="display:none;">データが見つかりませんでした。</div>
<button id="saveButton" style="display:none;">選択したデータを保存</button>

<script>
    document.getElementById('fileInput').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('logInput').value = e.target.result;
            };
            reader.readAsText(file);
        }
    });

    document.getElementById('decodeButton').addEventListener('click', function() {
        const input = document.getElementById('logInput').value;
        const exportPattern = /(\d{4}\.\d{2}\.\d{2} \d{2}:\d{2}:\d{2}).*?\[QVPEN_EXPORTER\] \[START_EXPORT\](.*?)\[QVPEN_EXPORTER\] \[END_EXPORT\]/gs;
        const base64Pattern = /\[QVPEN_EXPORTER\] \[START\](.*?)\[END\]/g;

        const exportList = document.getElementById('exportList');
        const message = document.getElementById('message');
        exportList.innerHTML = '';
        message.style.display = 'none';
        let exports = [];
        let match;

        while ((match = exportPattern.exec(input)) !== null) {
            const timestamp = match[1];
            const exportData = match[2];
            const base64Data = [];
            let base64Match;

            while ((base64Match = base64Pattern.exec(exportData)) !== null) {
                try {
                    const jsonString = atob(base64Match[1]);
                    const jsonObject = JSON.parse(jsonString);
                    base64Data.push(jsonObject);
                } catch (e) {
                    console.error('デコードエラー:', e);
                }
            }

            if (base64Data.length > 0) {
                exports.push({
                    timestamp: timestamp,
                    data: base64Data
                });

                const div = document.createElement('div');
                div.className = 'export-item';
                div.innerHTML = `
                        <input type="radio" name="export" value="${exports.length - 1}">
                        <label>エクスポート時刻: ${timestamp} (${base64Data.length} データ)</label>
                    `;
                exportList.appendChild(div);
            }
        }

        if (exports.length === 0) {
            message.style.display = 'block';
        } else {
            document.getElementById('saveButton').style.display = 'block';
        }

        document.getElementById('saveButton').onclick = function() {
            const selected = document.querySelector('input[name="export"]:checked');
            if (selected) {
                const selectedData = exports[selected.value];
                const resultJson = {
                    timestamp: selectedData.timestamp,
                    exportedData: selectedData.data
                };
                const blob = new Blob([JSON.stringify(resultJson, null, 2)],
                    { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `export_${selectedData.timestamp.replace(/[^0-9]/g, '_')}.json`;
                link.click();
            }
        };
    });
</script>
</body>
</html>
